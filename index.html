<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FRC Guess</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/img/robot.png" type="image/png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body{padding-top:4rem}
    .card{cursor:pointer;transition:transform .2s}
    .card:hover{transform:scale(1.05)}
    .win{background-color:#d4edda!important}
    .lose{background-color:#f8d7da!important}
    .team-list{display:flex;justify-content:center;gap:.75rem;flex-wrap:wrap}
    .team{display:flex;flex-direction:column;align-items:center;width:80px}
    .team img{width:60px;height:60px;object-fit:contain;border:1px solid #dee2e6;border-radius:.5rem;background:#fff}
    .team span{font-size:.85rem;margin-top:.25rem}
  </style>
</head>
<body class="bg-light">
<div class="container">
  <h1 class="text-center mb-4">FRC Guess</h1>
  <div class="mb-3 text-center">
    <button id="sign-in" class="btn btn-outline-primary">Sign in with Google</button>
    <button id="sign-out" class="btn btn-outline-secondary d-none">Sign out</button>
    <span id="user-info" class="ms-2 fst-italic"></span>
  </div>
  <div class="text-center">
    <p class="lead">Click “New Match” to guess which alliance wins!</p>
    <button id="new-match" class="btn btn-primary mb-3">New Match</button>
    <p id="meta" class="h5 mb-2"></p>
    <div id="timer" class="h4 text-danger fw-bold mb-2"></div>
    <div id="match-info" class="row g-3"></div>
  </div>
  <div id="result-area" class="text-center mt-4"></div>
  <div class="card mt-4" id="leaderboard-card">
    <div class="card-body">
      <h4 class="card-title">Leaderboard</h4>
      <table class="table table-sm" id="leaderboard-table"><thead><tr><th>#</th><th>Name</th><th>ELO</th></tr></thead><tbody></tbody></table>
    </div>
  </div>
</div>
<script>
/***** CONFIG *****/
const API_PREFIX="/.netlify/functions/tba?path=";
const YEARS=[2016,2025];
const K=32;
const TIMER_S=10;
const PLACEHOLDER="/img/placeholder.png";

/***** Firebase *****/
firebase.initializeApp({apiKey:"AIzaSyC8Gb6f8z3RLrVKuHyWd3TyC9EgQG9oEng",authDomain:"hosting-d2c1e.firebaseapp.com",projectId:"hosting-d2c1e",storageBucket:"hosting-d2c1e.appspot.com",messagingSenderId:"756373908988",appId:"1:756373908988:web:702d27d6cc8fedb132d679"});
const auth=firebase.auth();
const db=firebase.firestore();

/***** GLOBALS *****/
let countdown=null,currentMatch=null,answered=false;
const eventsCache=new Map(),matchesCache=new Map(),avatarCache=new Map();

/***** AUTH UI *****/
const signInBtn=document.getElementById('sign-in'),signOutBtn=document.getElementById('sign-out'),userInfo=document.getElementById('user-info');
signInBtn.onclick=()=>auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>alert(e.message));
signOutBtn.onclick=()=>auth.signOut();

auth.onAuthStateChanged(async u=>{
  signInBtn.classList.toggle('d-none',!!u);
  signOutBtn.classList.toggle('d-none',!u);
  userInfo.textContent=u?u.displayName:'';
  if(u){const r=db.collection('users').doc(u.uid);if(!(await r.get()).exists)await r.set({name:u.displayName,rating:1000});}
  refreshLB();
});

async function refreshLB(){
  const tb=document.querySelector('#leaderboard-table tbody');tb.innerHTML='';
  let r=1;const me=auth.currentUser;
  (await db.collection('users').orderBy('rating','desc').limit(10).get()).forEach(d=>{
    const v=d.data();
    tb.insertAdjacentHTML('beforeend',`<tr${d.id===me?.uid?' class="table-primary"':''}><td>${r++}</td><td>${v.name}</td><td>${Math.round(v.rating)}</td></tr>`);
  });
}
async function updateElo(ok){
  const u=auth.currentUser;if(!u)return;
  const ref=db.collection('users').doc(u.uid);
  await db.runTransaction(async tx=>{
    const s=await tx.get(ref);if(!s.exists)return;
    const cur=s.data().rating||1000;
    tx.update(ref,{rating:cur+K*((ok?1:0)-.5)});
  });
  refreshLB();
}

/***** GAME FLOW *****/
const newMatchBtn=document.getElementById('new-match');
let cd=false;
newMatchBtn.onclick=()=>{if(cd)return;cd=true;newMatchBtn.disabled=true;newMatch().finally(()=>setTimeout(()=>{cd=false;newMatchBtn.disabled=false},1200));};

async function newMatch(){
  resetUI();
  try{
    const y=randBetween(...YEARS);
    const e=randPick((await getEvents(y)).filter(ev=>ev.event_type<=1));
    const m=randPick((await getMatches(e.key)).filter(v=>v.winning_alliance));
    currentMatch=m;answered=false;showMatch(e,m);
  }catch(err){console.error(err);alert('Blue Alliance error: '+err.message);} }

function resetUI(){
  if(countdown)clearInterval(countdown);
  ['timer','meta','match-info','result-area'].forEach(id=>document.getElementById(id).innerHTML='');
  document.getElementById('leaderboard-card').classList.remove('win','lose');
}

function showMatch(event,match){
  document.getElementById('meta').textContent=`${event.year} – ${event.name} – ${(match.comp_level==='qm'?'Qualification':match.comp_level.toUpperCase())} #${match.match_number}`;
  const box=document.getElementById('match-info');box.innerHTML='';
  ['red','blue'].forEach(color=>{
    const teams=match.alliances[color].team_keys;
    box.appendChild(renderCard(color,teams));
    teams.forEach(async tk=>{
      const url=await getAvatar(tk,event.year);
      const img=document.getElementById(`img-${tk}`);
      if(img && url && !img.dataset.loaded){img.src=url;img.dataset.loaded='true';}
    });
  });
  startTimer();
}

function renderCard(color,teams){
  const html=teams.map(tk=>`<div class="team"><img id="img-${tk}" src="${PLACEHOLDER}" alt="${tk.slice(3)}"><span>${tk.slice(3)}</span></div>`).join('');
  const col=document.createElement('div');col.className='col-md-6';
  col.innerHTML=`<div class="card shadow-sm" data-color="${color}"><div class="card-body"><h4 class="card-title text-capitalize mb-3">${color} alliance</h4><div class="team-list">${html}</div></div></div>`;
  col.querySelector('.card').onclick=()=>guess(color);
  return col;
}

function startTimer(){
  let t=TIMER_S;
  const el=document.getElementById('timer');el.textContent=`${t}s`;
  countdown=setInterval(()=>{
    t--;
    if(t===8) ensurePlaceholders();
    if(t<=0){clearInterval(countdown);guess(null,true);} // true => timeout
    el.textContent=`${t}s`;
  },1000);
}

function guess(color,timeout=false){
  if(answered)return;answered=true;if(countdown)clearInterval(countdown);
  const win=currentMatch.winning_alliance;
  document.querySelectorAll('#match-info .card').forEach(c=>c.classList.add(c.getAttribute('data-color')===win?'win':'lose'));
  document.getElementById('leaderboard-card').classList.add(color===win?'win':'lose');

  let heading;
  if(timeout){heading='Timeout!';}
  else if(color===win){heading='Correct!';}
  else{heading='Wrong!';}

  document.getElementById('result-area').innerHTML=`<h3>${heading}</h3><p>Red: ${currentMatch.alliances.red.score} | Blue: ${currentMatch.alliances.blue.score}</p><a target="_blank" href="https://www.thebluealliance.com/match/${currentMatch.key}">Match details & video</a>`;
  updateElo(color===win && !timeout);
}

function ensurePlaceholders(){
  document.querySelectorAll(`img[src=""]`).forEach(img=>{img.src=PLACEHOLDER;});
}

/***** BLUE ALLIANCE API helpers *****/
async function tba(ep){const res=await fetch(`${API_PREFIX}${ep}`);if(!res.ok)throw new Error(`TBA ${res.status}`);return res.json();}
function getEvents(y){if(eventsCache.has(y))return Promise.resolve(eventsCache.get(y));return tba(`/events/${y}`).then(d=>{eventsCache.set(y,d);return d;});}
function getMatches(k){if(matchesCache.has(k))return Promise.resolve(matchesCache.get(k));return tba(`/event/${k}/matches`).then(d=>{matchesCache.set(k,d);return d;});}
async function getAvatar(teamKey,year){const id=`${teamKey}-${year}`;if(avatarCache.has(id))return avatarCache.get(id);try{const m=await tba(`/team/${teamKey}/media/${year}`);const a=m.find(x=>x.type==='avatar');const url=a&&a.details&&a.details.base64Image?`data:image/png;base64,${a.details.base64Image}`:PLACEHOLDER;avatarCache.set(id,url);return url;}catch{return PLACEHOLDER;}}
/***** UTILITIES *****/
const randPick=a=>a[Math.floor(Math.random()*a.length)];
const randBetween=(min,max)=>Math.floor(Math.random()*(max-min+1))+min;
</script>
</body>
</html>
